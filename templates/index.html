<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EHR-Asst | Explainable EHR Query Assistant</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- ================= INLINE CSS (script.css) ================= -->
  <style>
    body.ehr-ui {
      background: #f5f6f7;
      height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      font-size: 14px;
    }

    /* Header */
    .ehr-header {
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .ehr-title .subtitle {
      color: #6c757d;
      font-size: 12px;
      margin-left: 6px;
    }

    /* Main */
    .ehr-main {
      flex: 1;
      overflow-y: auto;
    }

    .ehr-chat {
      padding: 15px;
    }

    /* Intro */
    .assistant-intro {
      text-align: center;
      color: #6c757d;
      margin-bottom: 20px;
    }

    .assistant-intro .example {
      font-size: 12px;
      margin-top: 4px;
    }

    /* Messages */
    .msg {
      margin-bottom: 16px;
    }

    .user-msg {
      text-align: right;
    }

    .assistant-msg {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
    }

    .msg .label {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .msg .content {
      font-size: 13px;
    }

    /* Interpretation */
    .interpretation ul {
      padding-left: 18px;
      margin: 6px 0;
    }

    .answer pre {
      background: #f8f9fa;
      border-radius: 4px;
      padding: 8px;
      font-size: 12px;
      max-height: 220px;
      overflow: auto;
    }

    /* Thinking */
    .thinking {
      font-style: italic;
      opacity: 0.7;
    }

    /* Input */
    .ehr-footer {
      background: #ffffff;
      border-top: 1px solid #ddd;
      padding: 10px 0;
    }

    .ehr-input-box {
      display: flex;
      gap: 8px;
    }

    .ehr-input-box input {
      flex: 1;
      border-radius: 6px;
      border: 1px solid #ced4da;
      padding: 6px 10px;
    }

    .ehr-input-box button {
      border-radius: 6px;
      padding: 6px 18px;
      background: #198754;
      color: white;
      border: none;
    }
  </style>
</head>

<body class="ehr-ui">

  <!-- Header -->
  <header class="ehr-header">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="ehr-title">
        ðŸ©º <strong>EHR-Asst</strong>
        <span class="subtitle">Explainable EHR Query Assistant</span>
      </div>
      <button id="clear" class="btn btn-sm btn-outline-danger">
        Reset
      </button>
    </div>
  </header>

  <!-- Chat / Reasoning Area -->
  <main class="ehr-main">
    <div id="chat-window" class="container ehr-chat">

      <div class="assistant-intro">
        <strong>EHR-Asst</strong><br>
        Ask questions step by step.
        <div class="example">
          Example: <em>show patient age â†’ where age &gt; 70 â†’ top 5</em>
        </div>
      </div>

    </div>
  </main>

  <!-- Input -->
  <footer class="ehr-footer">
    <div class="container">
      <div class="ehr-input-box">
        <input
          id="nlp-input"
          type="text"
          placeholder="Enter your questionâ€¦"
        />
        <button id="runNLPQuery">Send</button>
      </div>
    </div>
  </footer>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- ================= INLINE JS (script.js) ================= -->
  <script>
    $(function () {

      $('#runNLPQuery').click(send);
      $('#nlp-input').keypress(e => {
        if (e.which === 13) send();
      });

      function scrollBottom() {
        const el = $('#chat-window')[0];
        el.scrollTop = el.scrollHeight;
      }

      function userMessage(text) {
        $('#chat-window').append(`
          <div class="msg user-msg">
            <div class="label">You</div>
            <div class="content">${text}</div>
          </div>
        `);
        scrollBottom();
      }

      function assistantThinking(id) {
        $('#chat-window').append(`
          <div class="msg assistant-msg" id="${id}">
            <div class="label">EHR-Asst</div>
            <div class="content thinking">
              Interpreting queryâ€¦
            </div>
          </div>
        `);
        scrollBottom();
      }

      function assistantResponse(steps, answer) {
        const stepsHtml = steps.map(s => `<li>${s}</li>`).join('');

        $('#chat-window').append(`
          <div class="msg assistant-msg">
            <div class="label">EHR-Asst</div>
            <div class="content">
              <div class="interpretation">
                <strong>My interpretation is:</strong>
                <ul>${stepsHtml}</ul>
              </div>
              <div class="answer">
                <strong>Answer:</strong>
                <pre>${answer}</pre>
              </div>
            </div>
          </div>
        `);
        scrollBottom();
      }

      function send() {
        const query = $('#nlp-input').val().trim();
        if (!query) return;

        userMessage(query);
        $('#nlp-input').val('');

        const thinkingId = `thinking-${Date.now()}`;
        assistantThinking(thinkingId);

        $.ajax({
          url: '/api/nlp_query',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ query }),

          success: function (res) {
            $('#' + thinkingId).remove();

            const steps = [];

            res.context.select_fields.forEach(f =>
              steps.push(`Fetch "${f}" from EHR`)
            );

            Object.entries(res.context.filters).forEach(([f, conds]) => {
              conds.forEach(([op, val]) =>
                steps.push(`Filter "${f}" ${op} ${val}`)
              );
            });

            steps.push(`Limit results to ${res.context.limit}`);

            const answer =
              res.results.length === 0
                ? "No matching records found."
                : JSON.stringify(res.results, null, 2);

            assistantResponse(steps, answer);
          },

          error: function () {
            $('#' + thinkingId).remove();
            assistantResponse(
              ["Unable to interpret the question"],
              "No answer available."
            );
          }
        });
      }

      $('#clear').click(function () {
        $.post('/api/reset_context');
        $('#chat-window').html(`
          <div class="assistant-intro">
            <strong>EHR-Asst</strong><br>
            Conversation reset. Start a new query.
          </div>
        `);
      });

    });
  </script>

</body>
</html>
